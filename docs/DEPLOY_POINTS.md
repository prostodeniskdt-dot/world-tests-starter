# Внедрение изменений системы очков (PostgreSQL)

Проект использует **PostgreSQL** (подключение через `DATABASE_URL` в `.env.local`). Миграции выполняются скриптом через тот же пул, что и приложение.

---

## Порядок внедрения

### 1. Применить миграции к БД (обязательно до деплоя)

В корне проекта, в консоли:

```bash
npx tsx scripts/run-points-migrations.ts
```

Или через npm:

```bash
npm run run-points-migrations
```

Скрипт по очереди выполнит:

- `20260216_points_race_and_no_deduction.sql` — блокировка гонки в `record_attempt`, запрет вычитания очков при худшем результате, колонка `attempts.idempotency_key`
- `20260216_submit_idempotency.sql` — таблица `submit_idempotency`
- `20260216_attempts_audit.sql` — при необходимости дополняет аудит по `idempotency_key`

Убедитесь, что в `.env.local` задан корректный `DATABASE_URL` для вашей PostgreSQL 18.

### 2. Сборка и запуск приложения

Локально:

```bash
npm install
npm run build
npm run start
```

Режим разработки:

```bash
npm run dev
```

### 3. Деплой на хостинг

После успешного применения миграций (шаг 1):

1. Закоммитьте изменения и запушьте в репозиторий.
2. На хостинге задайте `DATABASE_URL` (и при необходимости `DB_SSL=true`).
3. На хостинге выполните сборку и старт по инструкциям платформы (обычно `npm install`, `npm run build`, `npm run start` или аналог).

Миграции на продакшене нужно выполнить **один раз** из машины, имеющей доступ к продакшен-БД (локально с продакшен `DATABASE_URL` в `.env.local` или с сервера):

```bash
npx tsx scripts/run-points-migrations.ts
```

---

## Кратко: команды в консоли

| Действие | Команда |
|----------|--------|
| Применить миграции системы очков | `npx tsx scripts/run-points-migrations.ts` или `npm run run-points-migrations` |
| Сборка | `npm run build` |
| Запуск продакшен-сервера | `npm run start` |
| Режим разработки | `npm run dev` |
| Обнулить очки у всех пользователей | `npm run reset-points` |

Миграции нужно применить **до** первого деплоя с новой системой очков; повторный запуск скрипта безопасен (миграции идемпотентны). **Миграции не обнуляют очки** — они только меняют схему БД.

### Обнуление очков у всех пользователей

Если нужно сбросить рейтинг (обнулить очки и счётчик пройденных тестов в таблице `user_stats`):

```bash
npm run reset-points
```

или:

```bash
npx tsx scripts/reset-points.ts
```

История попыток (`attempts`) при этом не удаляется.
